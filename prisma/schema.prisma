generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                Int               @id @default(autoincrement())
  email             String            @unique
  name              String?
  role              UserRole          @default(USER)
  isActive          Boolean           @default(true)
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt
  password          String
  bio               String?
  location          String?
  username          String?
  image             String?
  phone             String?
  cardActivities    Activity[]
  archivedCards     Card[]            @relation("CardArchivedBy")
  assignedCards     Card[]            @relation("CardAssignee")
  createdCards      Card[]            @relation("CardCreator")
  createdCategories Category[]        @relation("CategoryCreator")
  ColorPreset       ColorPreset[]
  cardComments      Comment[]
  hostedGames       GameSession[]
  notifications     Notification[]
  playedGames       Player[]
  createdTemplates  Template[]        @relation("TemplateCreator")
  achievements      UserAchievement[]
  settings          UserSettings?

  @@map("users")
}

model Achievement {
  id          Int               @id @default(autoincrement())
  name        String            @unique
  description String
  icon        String            @default("Trophy")
  condition   String
  points      Int               @default(10)
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt
  users       UserAchievement[]

  @@map("achievements")
}

model UserAchievement {
  id            Int         @id @default(autoincrement())
  userId        Int
  achievementId Int
  unlockedAt    DateTime    @default(now())
  achievement   Achievement @relation(fields: [achievementId], references: [id], onDelete: Cascade)
  user          User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, achievementId])
  @@map("user_achievements")
}

model ColorPreset {
  id              Int        @id @default(autoincrement())
  name            String     @db.VarChar(50)
  description     String?
  backgroundColor String     @db.VarChar(7)
  textColor       String     @db.VarChar(7)
  textBoxColor    String     @db.VarChar(7)
  isActive        Boolean    @default(true)
  isDefault       Boolean    @default(false)
  usageCount      Int        @default(0)
  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt
  createdById     Int?
  categories      Category[]
  createdBy       User?      @relation(fields: [createdById], references: [id])

  @@map("color_presets")
}

model GameSession {
  id                String                @id @default(cuid())
  gameCode          String                @unique
  hostId            Int
  status            GameStatus            @default(WAITING)
  currentCardIndex  Int                   @default(0)
  startedAt         DateTime?
  endedAt           DateTime?
  createdAt         DateTime              @default(now())
  updatedAt         DateTime              @updatedAt
  gameMode          String                @default("Standard")
  name              String
  cardsPerRound     Int                   @default(3)
  currentRound      Int                   @default(1)
  initialBudget     Int                   @default(5000)
  lastCardStartedAt DateTime?
  numberOfTeams     Int                   @default(2)
  shuffledCardIds   Int[]                 @default([])
  totalRounds       Int?
  leaderTermLength  Int                   @default(4)
  gameDurationMinutes Int                 @default(60)
  roundStatus       String                @default("LEADER_ELECTION") // LEADER_ELECTION, DECISION_PHASE, RESULTS_PHASE
  lastTurnResult    Json?                 // Stores the results of the last turn (score/budget changes) for display
  categories        GameSessionCategory[]
  host              User                  @relation(fields: [hostId], references: [id])
  leaderVotes       LeaderVote[]
  players           Player[]
  teams             Team[]

  @@index([hostId])
  @@index([status])
  @@map("game_sessions")
}

model GameSessionCategory {
  id            String      @id @default(cuid())
  gameSessionId String
  categoryId    Int
  createdAt     DateTime    @default(now())
  category      Category    @relation(fields: [categoryId], references: [id])
  gameSession   GameSession @relation(fields: [gameSessionId], references: [id], onDelete: Cascade)

  @@unique([gameSessionId, categoryId])
  @@index([gameSessionId])
  @@index([categoryId])
}

model Category {
  id            Int                   @id @default(autoincrement())
  name          String                @unique
  description   String?
  createdBy     Int
  createdAt     DateTime              @default(now())
  updatedAt     DateTime              @updatedAt
  colorPresetId Int?
  isArchived    Boolean               @default(false)
  status        Status                @default(ACTIVE)
  color         String                @default("#6b7280")
  gameSessions  GameSessionCategory[]
  cards         Card[]
  colorPreset   ColorPreset?          @relation(fields: [colorPresetId], references: [id])
  creator       User                  @relation("CategoryCreator", fields: [createdBy], references: [id])
  templates     Template[]

  @@map("categories")
}

model Player {
  id            Int              @id @default(autoincrement())
  gameSessionId String
  nickname      String
  score         Int              @default(0)
  joinedAt      DateTime         @default(now())
  isConnected   Boolean          @default(true)
  isLeader      Boolean          @default(false)
  lastSeen      DateTime         @default(now())
  teamId        String?
  userId        Int?
  votedForId    Int?
  votesReceived Int              @default(0)
  votesRcvd     LeaderVote[]     @relation("CandidateVotes")
  votesGiven    LeaderVote[]     @relation("VoterVotes")
  responses     PlayerResponse[]
  gameSession   GameSession      @relation(fields: [gameSessionId], references: [id], onDelete: Cascade)
  team          Team?            @relation(fields: [teamId], references: [id])
  user          User?            @relation(fields: [userId], references: [id])

  @@unique([gameSessionId, nickname])
  @@index([gameSessionId])
  @@index([teamId])
  @@map("players")
}

model Card {
  id              Int              @id @default(autoincrement())
  title           String
  description     String?
  categoryId      Int
  createdBy       Int
  assignedTo      Int?
  archivedById    Int?
  isArchived      Boolean          @default(false)
  archivedAt      DateTime?
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  timeLimit       Int?
  status          String           @default("OPEN")
  activities      Activity[]
  attachments     Attachment[]
  cardResponses   CardResponse[]
  archivedBy      User?            @relation("CardArchivedBy", fields: [archivedById], references: [id])
  assignee        User?            @relation("CardAssignee", fields: [assignedTo], references: [id])
  category        Category         @relation(fields: [categoryId], references: [id])
  creator         User             @relation("CardCreator", fields: [createdBy], references: [id])
  comments        Comment[]
  playerResponses PlayerResponse[]

  @@index([status])
  @@index([categoryId])
  @@index([isArchived])
  @@index([title])
  @@map("cards")
}

model CardResponse {
  id                   Int              @id @default(autoincrement())
  cardId               Int
  text                 String
  order                Int              @default(0)
  createdAt            DateTime         @default(now())
  updatedAt            DateTime         @default(now())
  cost                 Int              @default(0)
  economicEffect       Int              @default(0)
  environmentEffect    Int              @default(0)
  infrastructureEffect Int              @default(0)
  politicalEffect      Int              @default(0)
  score                Int              @default(0)
  societyEffect        Int              @default(0)
  impactDescription    String?
  card                 Card             @relation(fields: [cardId], references: [id], onDelete: Cascade)
  playerResponses      PlayerResponse[]

  @@map("card_responses")
}

model Comment {
  id         Int      @id @default(autoincrement())
  content    String
  cardId     Int
  userId     Int
  isInternal Boolean  @default(false)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @default(now())
  card       Card     @relation(fields: [cardId], references: [id], onDelete: Cascade)
  user       User     @relation(fields: [userId], references: [id])

  @@map("comments")
}

model Activity {
  id          Int          @id @default(autoincrement())
  cardId      Int
  userId      Int
  action      ActivityType
  description String
  oldValue    String?
  newValue    String?
  metadata    Json?
  createdAt   DateTime     @default(now())
  card        Card         @relation(fields: [cardId], references: [id], onDelete: Cascade)
  user        User         @relation(fields: [userId], references: [id])

  @@map("activities")
}

model Attachment {
  id           Int      @id @default(autoincrement())
  cardId       Int
  fileName     String
  originalName String
  filePath     String
  fileSize     Int
  mimeType     String
  uploadedBy   Int
  createdAt    DateTime @default(now())
  card         Card     @relation(fields: [cardId], references: [id], onDelete: Cascade)

  @@map("attachments")
}

model Template {
  id          Int      @id @default(autoincrement())
  name        String   @unique
  description String?
  title       String
  content     String
  severity    Severity @default(MEDIUM)
  priority    Priority @default(MEDIUM)
  categoryId  Int
  createdBy   Int
  tags        String[]
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @default(now())
  category    Category @relation(fields: [categoryId], references: [id])
  creator     User     @relation("TemplateCreator", fields: [createdBy], references: [id])

  @@map("templates")
}

model Notification {
  id        Int              @id @default(autoincrement())
  userId    Int
  title     String
  message   String
  type      NotificationType @default(INFO)
  isRead    Boolean          @default(false)
  cardId    Int?
  createdAt DateTime         @default(now())
  user      User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("notifications")
}

model UserSettings {
  id                 Int      @id @default(autoincrement())
  userId             Int      @unique
  emailNotifications Boolean  @default(true)
  pushNotifications  Boolean  @default(false)
  soundEffects       Boolean  @default(true)
  autoSave           Boolean  @default(true)
  difficulty         String   @default("medium")
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt
  user               User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_settings")
}

model PlayerResponse {
  id          String       @id @default(cuid())
  playerId    Int
  cardId      Int
  responseId  Int
  respondedAt DateTime     @default(now())
  card        Card         @relation(fields: [cardId], references: [id], onDelete: Cascade)
  player      Player       @relation(fields: [playerId], references: [id], onDelete: Cascade)
  response    CardResponse @relation(fields: [responseId], references: [id], onDelete: Cascade)

  @@unique([playerId, cardId])
  @@map("player_responses")
}

model Team {
  id            String       @id @default(cuid())
  gameSessionId String
  name          String
  budget        Int          @default(5000)
  baseValue     Int          @default(5)
  color         String       @default("#3B82F6")
  order         Int          @default(0)
  lastLeaderElectionRound Int @default(0)
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt
  leaderVotes   LeaderVote[]
  players       Player[]
  gameSession   GameSession  @relation(fields: [gameSessionId], references: [id], onDelete: Cascade)

  @@index([gameSessionId])
  @@map("teams")
}

model LeaderVote {
  id            String      @id @default(cuid())
  gameSessionId String
  teamId        String
  round         Int
  voterId       Int
  candidateId   Int
  createdAt     DateTime    @default(now())
  candidate     Player      @relation("CandidateVotes", fields: [candidateId], references: [id], onDelete: Cascade)
  gameSession   GameSession @relation(fields: [gameSessionId], references: [id], onDelete: Cascade)
  team          Team        @relation(fields: [teamId], references: [id], onDelete: Cascade)
  voter         Player      @relation("VoterVotes", fields: [voterId], references: [id], onDelete: Cascade)

  @@unique([gameSessionId, voterId, round])
  @@index([gameSessionId, round])
  @@index([teamId, round])
  @@map("leader_votes")
}

enum UserRole {
  ADMIN
  MANAGER
  USER
  VIEWER
}

enum Severity {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum Status {
  ACTIVE
  INACTIVE
}

enum Priority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum ActivityType {
  CREATED
  UPDATED
  ASSIGNED
  UNASSIGNED
  STATUS_CHANGED
  PRIORITY_CHANGED
  SEVERITY_CHANGED
  COMMENTED
  ARCHIVED
  RESTORED
  DELETED
}

enum NotificationType {
  INFO
  WARNING
  ERROR
  SUCCESS
}

enum GameStatus {
  WAITING
  IN_PROGRESS
  PAUSED
  COMPLETED
}
